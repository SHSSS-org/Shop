<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHSSS Marketplace</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#007bff; color:#fff; padding:1rem; text-align:center; }
.container { max-width:1200px; margin:20px auto; padding:0 1rem; }
h2 { color:#333; }
.product { background:#fff; padding:1rem; margin-bottom:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; gap:1rem; }
.product img { width:150px; height:150px; object-fit:cover; border-radius:8px; }
.product-details { flex:1; }
form { background:#fff; padding:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:2rem; }
input, select, textarea, button { display:block; width:100%; margin-bottom:0.5rem; padding:0.5rem; font-size:1rem; }
button { background:#007bff; color:#fff; border:none; cursor:pointer; border-radius:5px; }
button:hover { background:#0056b3; }
.error { color:red; font-weight:bold; }
.success { color:green; font-weight:bold; }
.admin-section { background:#fff; padding:1rem; border-radius:8px; margin-top:2rem; }
</style>
</head>
<body>

<header>
    <h1>SHSSS Marketplace</h1>
</header>

<div class="container">

    <!-- Product Submission Form -->
    <section id="submit-section">
        <h2>Submit a Product</h2>
        <form id="submit-form">
            <input type="text" name="seller_name" placeholder="Your Name" required>
            <input type="email" name="seller_email" placeholder="Your Email" required>
            <input type="text" name="product_name" placeholder="Product Name" required>
            <select name="product_condition" required>
                <option value="">Select Condition</option>
                <option value="New">New</option>
                <option value="Slightly Used">Slightly Used</option>
                <option value="Heavily Used">Heavily Used</option>
            </select>
            <input type="text" name="room_number" placeholder="Room Number" required>
            <input type="number" name="year_bought" placeholder="Year Bought (optional)">
            <input type="text" name="image_url" placeholder="Google Drive Image Link" required>
            <textarea name="description" placeholder="Product Description" rows="4" required></textarea>
            <button type="submit">Submit Product</button>
            <div id="submit-msg"></div>
        </form>
    </section>

    <!-- Products List -->
    <section id="products-section">
        <h2>Available Products</h2>
        <div id="products-list"></div>
    </section>

    <!-- Admin Login -->
    <section class="admin-section">
        <h2>Admin Login</h2>
        <form id="admin-login-form">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
            <div id="admin-msg"></div>
        </form>
    </section>

</div>

<script>
const API_BASE = "https://shop-y2ev.onrender.com/api";

// Fetch approved products
async function loadProducts() {
    const list = document.getElementById("products-list");
    list.innerHTML = "Loading...";
    try {
        const res = await fetch(`${API_BASE}/products`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("Invalid response");
        if(data.length === 0) list.innerHTML = "<p>No products yet.</p>";
        else list.innerHTML = data.map(p => `
            <div class="product">
                <img src="${p.image_url}" alt="${p.product_name}">
                <div class="product-details">
                    <h3>${p.product_name}</h3>
                    <p><strong>Condition:</strong> ${p.product_condition}</p>
                    <p><strong>Seller:</strong> ${p.seller_name} (${p.seller_email})</p>
                    <p><strong>Room:</strong> ${p.room_number}</p>
                    <p><strong>Year:</strong> ${p.year_bought || "N/A"}</p>
                    <p>${p.description}</p>
                </div>
            </div>
        `).join("");
    } catch(e) {
        list.innerHTML = `<p class="error">Failed to load products: ${e.message}</p>`;
    }
}

// Submit product
document.getElementById("submit-form").addEventListener("submit", async e => {
    e.preventDefault();
    const msg = document.getElementById("submit-msg");
    msg.textContent = "";
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    // Convert empty year to null
    if(!data.year_bought) data.year_bought = null;

    try {
        const res = await fetch(`${API_BASE}/products`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if(result.success) {
            msg.textContent = result.message;
            msg.className = "success";
            form.reset();
        } else {
            msg.textContent = result.message;
            msg.className = "error";
        }
    } catch(err) {
        msg.textContent = "Network error";
        msg.className = "error";
    }
});

// Admin login
document.getElementById("admin-login-form").addEventListener("submit", async e => {
    e.preventDefault();
    const msg = document.getElementById("admin-msg");
    msg.textContent = "";
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());

    try {
        const res = await fetch(`${API_BASE}/admin/login`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if(result.success){
            msg.textContent = "Login successful! Token: " + result.token;
            msg.className = "success";
            form.reset();
            localStorage.setItem("admin_token", result.token);
        } else {
            msg.textContent = result.message;
            msg.className = "error";
        }
    } catch(err){
        msg.textContent = "Network error";
        msg.className = "error";
    }
});

// Initial load
loadProducts();
</script>

</body>
</html>
